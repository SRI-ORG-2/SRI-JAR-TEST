name: Repro - Billy JAR vs Image

on:
  push:
  pull_request:

jobs:
  build-and-scan:
    name: Build JAR, Image and run Billy scans
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Java (Temurin 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'maven'

      - name: Build WebFlux fat JAR
        working-directory: java-repro
        run: |
          set -euo pipefail
          mvn -B -DskipTests package
          echo "Built JAR:"
          ls -lah target/*.jar || true
          echo "List BOOT-INF entries (showing a few):"
          jar tf target/*.jar | grep -E "^BOOT-INF/lib/" | head -n 10 || true

      - name: Build Docker image (contains the JAR)
        working-directory: java-repro
        run: |
          set -euo pipefail
          docker build -t webflux-repro:test .

      - name: Install Billy (simple installer)
        run: |
          set -euo pipefail
          # download and install into current workspace
          curl -sLo install.sh "https://download.codesec.aquasec.com/billy/install.sh"
          chmod +x install.sh
          BINDIR="." sh install.sh
          ./billy --version

      - name: Billy scan - JAR artifact
        env:
          TRIVY_USERNAME: ${{ secrets.TRIVY_USERNAME }}
          TRIVY_PASSWORD: ${{ secrets.TRIVY_PASSWORD }}
          AQUA_KEY: ${{ secrets.AQUA_KEY }}
          AQUA_SECRET: ${{ secrets.AQUA_SECRET }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p sbom_jar
          ./billy generate \
            --access-token "${GITHUB_TOKEN}" \
            --aqua-key "${AQUA_KEY}" \
            --aqua-secret "${AQUA_SECRET}" \
            --artifact-path "java-repro/target/*.jar" \
            --log-file billy-jar.log \
            --sbom-path sbom_jar || true
          echo "=== Billy JAR logfile ==="
          sed -n '1,200p' billy-jar.log || true

      - name: Billy scan - Docker image artifact
        env:
          TRIVY_USERNAME: ${{ secrets.TRIVY_USERNAME }}
          TRIVY_PASSWORD: ${{ secrets.TRIVY_PASSWORD }}
          AQUA_KEY: ${{ secrets.AQUA_KEY }}
          AQUA_SECRET: ${{ secrets.AQUA_SECRET }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          mkdir -p sbom_image
          ./billy generate \
            --access-token "${TOKEN_GITHUB}" \
            --aqua-key "${AQUA_KEY}" \
            --aqua-secret "${AQUA_SECRET}" \
            --artifact-path "webflux-repro:test" \
            --log-file billy-image.log \
            --sbom-path sbom_image || true
          echo "=== Billy IMAGE logfile ==="
          sed -n '1,200p' billy-image.log || true

      - name: Upload SBOMs and logs
        uses: actions/upload-artifact@v4
        with:
          name: billy-repro-output
          path: |
            sbom_jar
            sbom_image
            billy-jar.log
            billy-image.log
